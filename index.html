<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yearbook Editor</title>

    <style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        background-color: #f0f0f0;
    }    

    #ybd {                /*YearBookData*/
        /* width ã¨ height ã¯ JS ã§å‹•çš„ã«è¨­å®š */
        background: #ffffff;
        background-image:
            linear-gradient(#f1c79d 1px, transparent 0),
            linear-gradient(90deg, #ed9a46 1px, transparent 0);
        background-size: 24px 24px;

        font-size: 24px;        /*æ–‡å­—ã‚µã‚¤ã‚º*/
        font-family: serif;    /*æ˜æœä½“æŒ‡å®š*/
        writing-mode: vertical-rl; /*vertical right to left*/
        text-orientation: upright; /*åŠè§’è‹±æ•°å­—ã‚‚ç¸¦æ›¸ãã«*/ 
        line-height: 1em;
        overflow: hidden; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ç¦æ­¢ (æŒ‡å®šãƒã‚¹ä»¥ä¸Šã¯å…¥åŠ›ä¸å¯) */
        border: 1px solid #ed9a46; /* å¤–æ  (è¨ˆç®—ã—ã‚„ã™ãã™ã‚‹ãŸã‚) */
    }

    #menu {
        margin: 4px 10px;
        text-align: center;
        font-family: serif; 
    }
    .btn {
        margin: 5px;
        padding: 2px 3px;
        text-decoration :none;
        text-align: center;
        transition: .4s;
        box-shadow: 5px 5px 5px rgba(0,0,0,0.3);    /*--æ°´å¹³æ–¹å‘ å‚ç›´æ–¹å‘ å½±ã®ã¼ã‹ã— è‰²--*/ 
    }
    .btn:hover {
        box-shadow: 0 0 10px rgba(0,0,0,0);
    }
    p {
        font-family: serif;
        font-size: 27px;
        writing-mode: vertical-rl; 
        height: 250px; /* ã‚¿ã‚¤ãƒˆãƒ«ã®é«˜ã•ã‚’ç¢ºä¿ */
    }
    .grid-setting {
        writing-mode: vertical-rl;
        margin: 10px 0;
        padding: 2px;
        border: 1px solid #ccc;
        border-radius: 5px;
        height: 150px; /* è¨­å®šã‚¨ãƒªã‚¢ã®é«˜ã•ã‚’ç¢ºä¿ */
    }
    .grid-setting label {
        font-size: 16px;
        margin-right: 5px;
    }
    .grid-setting input[type="number"] {
        width: 40px; /* å…¥åŠ›æ¬„ã®å¹… */
        font-size: 16px;
        text-align: center;
        /* ç¸¦æ›¸ãå†…ã®ãƒ†ã‚­ã‚¹ãƒˆå‘ã */
        writing-mode: horizontal-tb; 
        text-orientation: mixed;
    }
    .grid-setting .btn {
        writing-mode: horizontal-tb; /* ãƒœã‚¿ãƒ³ã¯æ¨ªæ›¸ã */
        margin-top: 10px;
    }
    </style>
</head>


<body>
    <div id="ybd" contenteditable="true" spellcheck="false" autofocus></div>
    <div id="menu">
        <p>ğŸŒ¸å’æ¥­æ–‡é›†ã‚¨ãƒ‡ã‚£ã‚¿</p><br>

        <div class="grid-setting">

            <label for="inputRows">è¡Œ</label>
            <input type="number" id="inputRows" value="22" min="1">
            <label for="inputCols">åˆ—</label>
            <input type="number" id="inputCols" value="27" min="1">            <input type="button" value="ä½œæˆ" class="btn" id="btnCreateGrid"></input>
        </div>
        
        <input type="button" value="ä¿å­˜" class="btn" onclick=save();></input><br>
        <input type="button" value="èª­è¾¼" class="btn" onclick=load();></input><br>
    </div>
    
    <script>
        const charSize = 24; // 1ãƒã‚¹ã®ã‚µã‚¤ã‚º(px)
        let maxChars = 0; // æœ€å¤§æ–‡å­—æ•°

        const editor = document.getElementById("ybd");
        const btnCreate = document.getElementById("btnCreateGrid");
        const inputRows = document.getElementById("inputRows");
        const inputCols = document.getElementById("inputCols");

        //ã‚°ãƒªãƒƒãƒ‰ã‚’ä½œæˆï¼ˆã¾ãŸã¯æ›´æ–°ï¼‰ã™ã‚‹é–¢æ•°
        function createGrid() {
            let rows = parseInt(inputRows.value) || 22;
            let cols = parseInt(inputCols.value) || 27;

            // æœ€å¤§æ–‡å­—æ•°ã‚’æ›´æ–°
            maxChars = rows * cols;

            // ã‚¨ãƒ‡ã‚£ã‚¿ã®ã‚µã‚¤ã‚ºã‚’è¨ˆç®—ã—ã¦è¨­å®š
            // å…ƒã‚³ãƒ¼ãƒ‰ã®ã‚³ãƒ¡ãƒ³ãƒˆã«åŸºã¥ãã€ç½«ç·š1æœ¬åˆ†(+1px)ã§ã¯ãªãã€borderã§1pxç¢ºä¿
            editor.style.height = (rows * charSize + 2) + 'px';
            editor.style.width = (cols * charSize + 1) + 'px';

            // ç¾åœ¨ã®ãƒ†ã‚­ã‚¹ãƒˆãŒæ–°ã—ã„ä¸Šé™ã‚’è¶…ãˆã¦ã„ãŸã‚‰ã‚«ãƒƒãƒˆã™ã‚‹
            truncateText();
        }

        //ç¾åœ¨ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ maxChars ã«åã‚ã‚‹é–¢æ•°
        function truncateText() {
            let currentText = editor.textContent || "";
            if (currentText.length > maxChars) {
                // textContentã§è¨­å®šã—ç›´ã™ï¼ˆæ›¸å¼ã¯æ¶ˆãˆã‚‹ãŒæ–‡å­—æ•°åˆ¶é™ã¯å®ˆã‚‰ã‚Œã‚‹ï¼‰
                editor.textContent = currentText.substring(0, maxChars);
                // ã‚«ãƒ¼ã‚½ãƒ«ã‚’æœ«å°¾ã«ç§»å‹•
                moveCaretToEnd();
            }
        }

        //ã‚­ãƒ¼å…¥åŠ›ã‚’åˆ¶é™ã™ã‚‹é–¢æ•°
        function limitInput(event) {
            const currentLength = editor.textContent.length;

            // è¨±å¯ã™ã‚‹ã‚­ãƒ¼ï¼ˆæ–‡å­—å…¥åŠ›ä»¥å¤–ï¼‰
            const allowedKeys = [
                'Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown',
                'Home', 'End', 'PageUp', 'PageDown', 'Tab'
            ];

            // Ctrl/Meta(Cmd)ã‚­ãƒ¼ãŒæŠ¼ã•ã‚Œã¦ã„ã‚‹å ´åˆ (ã‚³ãƒ”ãƒ¼ã€ãƒšãƒ¼ã‚¹ãƒˆã€å…¨é¸æŠãªã©) ã¯è¨±å¯
            if (event.ctrlKey || event.metaKey) {
                return;
            }

            // æœ€å¤§æ–‡å­—æ•°ã«é”ã—ã¦ã„ã¦ã€è¨±å¯ã‚­ãƒ¼ä»¥å¤–ãŒæŠ¼ã•ã‚ŒãŸã‚‰å…¥åŠ›ã‚’é˜²ã
            if (currentLength >= maxChars && !allowedKeys.includes(event.key)) {
                event.preventDefault();
            }
        }

        //ãƒšãƒ¼ã‚¹ãƒˆï¼ˆè²¼ã‚Šä»˜ã‘ï¼‰ã‚’åˆ¶é™ã™ã‚‹é–¢æ•°
        function limitPaste(event) {
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒšãƒ¼ã‚¹ãƒˆå‹•ä½œã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            event.preventDefault();

            // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            const pasteText = (event.clipboardData || window.clipboardData).getData('text');
            const currentLength = editor.textContent.length;
            const remainingSpace = maxChars - currentLength;

            // è²¼ã‚Šä»˜ã‘ã‚‰ã‚Œã‚‹ã‚¹ãƒšãƒ¼ã‚¹ãŒãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„
            if (remainingSpace <= 0) {
                return;
            }

            // æ®‹ã‚Šã®ã‚¹ãƒšãƒ¼ã‚¹ã«åã¾ã‚‹ã‚ˆã†ã«ãƒšãƒ¼ã‚¹ãƒˆå†…å®¹ã‚’ã‚«ãƒƒãƒˆ
            const textToInsert = pasteText.substring(0, remainingSpace);

            // ã‚«ãƒƒãƒˆã—ãŸãƒ†ã‚­ã‚¹ãƒˆã‚’æŒ¿å…¥ (ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã«æŒ¿å…¥ã•ã‚Œã‚‹)
            document.execCommand('insertText', false, textToInsert);
        }

        //ãƒ†ã‚­ã‚¹ãƒˆç·¨é›†å¾Œã«ã‚«ãƒ¼ã‚½ãƒ«ã‚’æœ«å°¾ã«ç§»å‹•ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function moveCaretToEnd() {
            const range = document.createRange();
            const sel = window.getSelection();
            if (editor.childNodes.length > 0) {
                range.setStart(editor.lastChild, editor.lastChild.textContent.length);
            } else {
                range.setStart(editor, 0);
            }
            range.collapse(true);
            sel.removeAllRanges();
            sel.addRange(range);
            editor.focus();
        }


        function load() {
            let yearbookData = "";
            if (!localStorage.getItem('yearbookData')) {
                yearbookData = "æ–‡é›†ãƒ‡ãƒ¼ã‚¿ã¯ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚";
                document.getElementById("ybd").innerHTML = yearbookData;
            } else {
                yearbookData = localStorage.getItem('yearbookData');
                
                // èª­ã¿è¾¼ã‚“ã ãƒ‡ãƒ¼ã‚¿ãŒç¾åœ¨ã®ãƒã‚¹ç›®ã‚’è¶…ãˆã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = yearbookData;
                let text = tempDiv.textContent || "";

                if (text.length > maxChars) {
                    alert('èª­ã¿è¾¼ã‚“ã ãƒ‡ãƒ¼ã‚¿ãŒç¾åœ¨ã®ãƒã‚¹ç›®(' + maxChars + 'å­—)ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚è¶…éåˆ†ã¯ã‚«ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚');
                    // textContentã§è¨­å®šï¼ˆæ›¸å¼ã¯å¤±ã‚ã‚Œã‚‹ï¼‰
                    document.getElementById("ybd").textContent = text.substring(0, maxChars);
                } else {
                    // åˆ¶é™å†…ãªã‚‰ãã®ã¾ã¾èª­ã¿è¾¼ã‚€
                    document.getElementById("ybd").innerHTML = yearbookData;
                }
            }
        }

        function save() {
            // å¿µã®ãŸã‚ã€ä¿å­˜å‰ã«ä¸Šé™ãƒã‚§ãƒƒã‚¯ï¼ˆé€šå¸¸ã¯å…¥åŠ›åˆ¶é™ã§è¶…ãˆãªã„ã¯ãšï¼‰
            truncateText(); 
            let yearbookData = document.getElementById("ybd").innerHTML;
            localStorage.setItem('yearbookData', yearbookData);
            alert("ä¿å­˜ã—ã¾ã—ãŸã€‚");
        }

        // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®ç™»éŒ² ---

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚°ãƒªãƒƒãƒ‰ã‚’ä½œæˆ
        window.addEventListener('load', createGrid);
        
        // ã€Œä½œæˆã€ãƒœã‚¿ãƒ³ã«ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™»éŒ²
        btnCreate.addEventListener('click', createGrid);

        // ã‚¨ãƒ‡ã‚£ã‚¿ã«å…¥åŠ›åˆ¶é™ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™»éŒ²
        editor.addEventListener('keydown', limitInput);
        editor.addEventListener('paste', limitPaste);

    </script>

</body>
</html>
